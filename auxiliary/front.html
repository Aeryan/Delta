<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1">
    <title>Deltabot</title>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.7/dist/semantic.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.7/dist/semantic.min.js"></script>
</head>
<body style="background-color: #f1f1f1;">
    <div class="ui container">
        <div class="ui grid">
            <div class="four wide computer sixteen wide mobile column">
                <div class="ui segment" style="text-align: center">
                    Welcome to Deltabot's testing environment. All conversations will be logged to help improve the chatbot.<br><br>Whenever you break the chatbot, feel free to refresh the page and attempt to break it again in a different way!
                </div>
            </div>
            <div class="eight wide computer sixteen wide mobile column">
                <div class="ui segment" style="background-color: #f1f1f1; max-height: 95vh; padding-left: 3px; padding-right: 3px;">
                    <div class="ui segment" style="overflow: auto; max-height: 85vh; padding: 0; background-color: #f1f1f1; border: hidden; box-shadow: none;">
                        <div id="textdiv"></div>
                        <div class="ui hidden divider" id="chatbox_bottom"></div>
                    </div>
                    <div class="ui fluid action input" style="max-width: 90%; margin: auto;">
                        <input type="text" id="user_input" style="border-color: white;" placeholder="Ask a question..." onsubmit="postMsg(false)">
                        <button class="ui icon button" style="background-color: white; padding: 0;">
                            <i class="big play circle icon" id="submit_btn" style="color: #b79a33;" onclick="postMsg(false)"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const id = Date.now();
        console.log(id)

        $('#user_input').on("keydown", function (e) {
            if (e.keyCode === 13) {
                postMsg(false);
            }
        });

        function postMsg(initial) {
            var msg;
            if (initial === false) {
                var user_marker = document.createElement("DIV");
                user_marker.innerText = "You";
                var user_node = document.createElement("DIV");
                user_node.appendChild(user_marker);
                user_node.classList.add("ui", "basic", "fitted", "segment");
                user_node.style = "text-align: left; margin: 3px;";
                document.getElementById("textdiv").appendChild(user_node);

                msg = document.getElementById("user_input").value;
                var message_node = document.createElement("DIV");
                message_node.appendChild(document.createTextNode(msg));
                message_node.classList.add("ui", "compact", "message");
                message_node.style = "background-color: white; text-color: b79a33; max-width: 80%;";
                var segment_node = document.createElement("DIV");
                segment_node.appendChild(message_node);
                segment_node.classList.add("ui", "basic", "fitted", "segment");
                segment_node.style = "text-align: left; margin: 3px;";
                document.getElementById("textdiv").appendChild(segment_node);
                document.getElementById("user_input").value = "";
            }
            else {
                msg = "initmsg";
            }

            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/webhook", true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {

                    var json = JSON.parse(xhr.responseText);
                    console.log(json);

                    var bot_marker = document.createElement("DIV");
                    bot_marker.innerText = "Deltabot";
                    bot_marker.style = "color: #b79a33;";
                    var bot_node = document.createElement("DIV");
                    bot_node.appendChild(bot_marker);
                    bot_node.classList.add("ui", "basic", "fitted", "segment");
                    bot_node.style = "text-align: right; margin: 3px;";
                    document.getElementById("textdiv").appendChild(bot_node);

                    for (var i = 0; i < json.length; i++) {
                        var segment_node = document.createElement("DIV");
                        if (json[i]['text'] === "") {
                            segment_node.classList.add("ui", "hidden", "divider");
                        }
                        else {
                            var message_node = document.createElement("DIV");
                            message_node.appendChild(document.createTextNode(json[i]['text']));
                            message_node.classList.add("ui", "compact", "message");
                            message_node.style = "background-color: #b79a33; max-width: 80%;";
                            segment_node.appendChild(message_node);
                            segment_node.classList.add("ui", "basic", "fitted", "segment");
                            segment_node.style = "text-align: right; margin: 3px;";
                        }
                        document.getElementById("textdiv").appendChild(segment_node);
                        document.getElementById("chatbox_bottom").scrollIntoView();
                    }
                }
            };
            var data = JSON.stringify({"sender": id, "message": msg});
            xhr.send(data);
            document.getElementById("chatbox_bottom").scrollIntoView()
        }

        postMsg(true);

    </script>
</body>
</html>